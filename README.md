# Optimization-based Integrated Decision-Making and Control Scheme with Traffic Rule Compliance in CARLA 0.9.13 Simulator

[![arXiv](https://img.shields.io/badge/arXiv-2304.01041-b31b1b.svg)](https://arxiv.org/pdf/2304.01041)
[![IEEE Xplore](https://img.shields.io/badge/IEEE%20Xplore-10.1109%2FTCST.2023.10354858-blue.svg)](https://ieeexplore.ieee.org/abstract/document/10354858)

This repository contains the implementation of an **Optimization-based Integrated Decision-Making and Control (IDMC)** scheme for autonomous vehicles in the CARLA 0.9.13 simulator. The scheme ensures **traffic rule compliance** and handles complex urban driving scenarios such as overtaking, collision avoidance, and traffic light adherence.

---

## Installation

### CARLA Simulator
Download and install the CARLA 0.9.13 simulator based on your operating system:

- **Windows**:  
  [CARLA_0.9.13.zip](https://carla-releases.s3.eu-west-3.amazonaws.com/Windows/CARLA_0.9.13.zip)

- **Ubuntu**:  
  Follow the official [CARLA installation guide](https://carla.readthedocs.io/en/latest/start_quickstart/#a-debian-carla-installation).

### Python Requirements
Install the required Python dependencies using:
```bash
pip install -r requirements.txt
```

---

## Running the Simulation

### Test Environment
1. Launch the CARLA simulator:
   ```bash
   CarlaUE4.exe  # Windows
   ./CarlaUE4.sh # Ubuntu
   ```

2. (Optional) Improve performance by disabling rendering:
   ```bash
   python official/config.py --no-rendering
   ```

3. Test the environment with the initialization script:
   ```bash
   python scripts/env.py
   ```

### Fast Algorithm Testing (Simplified Pyplot Environment)
Run the following scripts to test the algorithm in a simplified environment without CARLA:
- **Overtaking and Adaptive Cruise Control (ACC)**:
  ```bash
  python APF_grid_01road_bound_dynamic_obstacle.py
  ```
- **Traffic Light Compliance with APF**:
  ```bash
  python APF_grid_02traffic_light_dynamic_obstacle.py
  ```

### CARLA Scenarios (Town03)
Run the following scripts for specific driving scenarios in CARLA:
- **Crossroad Driving and Emergency Collision Avoidance**:
  ```bash
  python APF_carla_1road_bound_dynamic_obstacle.py crossroad
  ```
- **Highway Driving and Overtaking**:
  ```bash
  python APF_carla_1road_bound_dynamic_obstacle.py multilaneACC
  ```
- **Roundabout Driving**:
  ```bash
  python APF_carla_1road_bound_dynamic_obstacle.py roundabout
  ```

---

## File Structure
```bash
birdview_v2_cache/       # Cache files generated by bird-eye view
official/               # Reference examples provided by CARLA
scripts/                # Core implementation (already released)
    env.py              # Interact with CARLA (spawn vehicles, visualization, etc.)
    other_agent.py      # Behavior of other vehicles (lane following, lane changing)
    vehicle_obs.py      # Simulate dynamics and calculate MPC with obstacle constraints
    vehicle_v2x_obs.py  # IDMC core with traffic rule compliance
    x_agent.py          # Main functions (ACC, overtaking, parking)
scenarios/              # Parameters for carpark and highway scenarios
utils/                  # Third-party or common functions
APF_carla_*.py          # Main scripts for CARLA scenarios
grid_*.py               # Main scripts for grid-based testing
```

---

## Scenario Information (Town05 for Future Exploration)
### Positions
- **Highway**:
  ```bash
  53.5, -204.3, 270
  -8, -204. 270
  11.3, 205.2, 90
  58.1, 205.0, 90
  ```
- **Parking Lot**:
  ```bash
  Entrance: 21.1, -30.8, 270
  Expected Parking Position: -6.7, -27.1, 90
  ```

---

## Low-Level Controller Design and Testing
The following scenarios are reimplemented in CARLA using `apply_control` instead of directly setting vehicle transformations:
- Lane following
- Obstacle avoidance

Additionally, the following scenarios are newly added:
- `APF_carla1road_bound_dynamic_obstacle.py`

---

## Results
Watch the IDMC algorithm in action in challenging urban driving scenarios with detailed explanations:  
[![YouTube](https://img.shields.io/badge/YouTube-Watch%20Video-red)](https://youtu.be/wzFhjzrvDg4)

---

## Running CARLA in Docker (Ubuntu 22.04 â†’ Ubuntu 20.04)
### Activate CARLA in Docker
```bash
sudo docker run --privileged --gpus all --net=host -e DISPLAY=$DISPLAY carlasim/carla:latest /bin/bash ./CarlaUE4.sh
```

### Set Up Python Environment
```bash
conda activate [python 3.8 env]
pip install carla_birdeye_view numpy tqdm carla pygame
```

---

## License
This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
