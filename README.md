# Optimization-based integrated decision-making and control scheme with traffic rule compliance in CARLA 0.9.13 simulator

This work is submitted to IROS 2023: IEEE/RSJ International Conference on Intelligent Robots and Systems.

## Install

### Carla Simulator
```bash
# Windows
https://carla-releases.s3.eu-west-3.amazonaws.com/Windows/CARLA_0.9.13.zip

# Ubuntu(follow the below instruction)
https://carla.readthedocs.io/en/latest/start_quickstart/#a-debian-carla-installation
```

### Python requirments

```bash
pip install -r requirements.txt
```

## RUN

### Test env.

```python
# 1. run 
CarlaUE4.exe # Windows
./CarlaUE4.sh  # Ubuntu

# 1.1 (optional) get additional performance improvement with no rendering
python official/config.py --no-rendering

# 2. test env scripts
# the scripts contains the process of basic initialization.
python scripts/env.py
```

### Run fast algorithm testing scenarios in a simplified pyplot-based env. without dependence of Carla
```bash
# overtaking and ACC in a road with three lanes and two dynamic surrounding vehicles
python APF_grid_01road_bound_dynamic_obstacle.py

# do the same task with traffic light rule compliance with the help of APF
python APF_grid_02traffic_light_dynamic_obstacle.py 
```

### Run carla scenarios (in Town03)
``` bash 
# crossroad driving and emergency collision avoidance with randomly generated surrounding vehicles
python APF_carla_1road_bound_dynamic_obstacle.py crossroad

# highway driving and overtaking with randomly generated surrounding vehicles
python APF_carla_1road_bound_dynamic_obstacle.py multilaneACC

# roundabout driving and seeking a changce to drive in and out the roundabout with randomly generated surrounding vehicles
python APF_carla_1road_bound_dynamic_obstacle.py roundabout
```

## File structure
```bash
-birdview_v2_cache # cache file generated by birdeye_view
-official # some reference examples provided by carla
-scripts # core implementation (for now the scripts are not open-source, we will release them after June 2023. Keep watching please!)
    - env.py # interact with carla, it includes spawn vehicles, initial visualization and carla environment, etc.
    - other_agent.py # Be in charge of the behavior of other vehicles, like following the lane and change lane
    - vehicle.py # simulate the dynamics and calculate MPC(solvers is casadi)
    - vehicle_acados.py # similar with vehicle.py except the solver is acados
    - vehicle_obs.py # similar with vehicle.py but adding the obstacle constraints
    - vehicle_v2x_obs.py # the IDAC core with traffic rules (lane keeping, not running to solid lane markings, not running a red light, etc)
    - vehicle_obs_parking.py # AD core for carparking_exe.py based on vehicle_obs.py
    - x_agent.py # implement the main function, such as acc, overtaking and parking
-scenarios # set parameter of carpark and highway scenario
-utils # some third party or common function
-APF_carla* # main entrance of this paper, run it from command line with a augment (crossroad, multilaneACC, roundabout,...), before that you need to launch CarlaUE4 following the instruction above.
-grid* and carla* # main entrance of program, run grid*.py to test the algorithm. The name with *grid* means testing in grid enviroment. carla* need to run carla simulator first.
```
## scenario infomation in Town05 for future exploration

```bash
# position
high_way(waypoint between intersection)
53.5, -204.3, 270
-8, -204. 270
11.3, 205.2, 90
58.1, 205.0, 90

parking lot entrance
21.1, -30.8, 270
expected parking position
-6.7, -27.1, 90
```
## low-level controller design and test
Reimplement the following senarios in Carla, we use 'apply_control' rather than setting tranformation of the vehicle directly.

- lane following
- obstacle avoidance

And newly add the following scenarios use 'apply_control' as well.

- APF_carla1road_bound_dynamic_obstacle.py
## Result
You can find the IDAC algorithm testing videos in some challenging urban autonomouos driving scenarios with explanations at [https://youtu.be/wzFhjzrvDg4](https://youtu.be/wzFhjzrvDg4).


https://user-images.githubusercontent.com/44318132/226151308-14d08ab5-2ae1-4e87-8032-66b8e14d6e5b.mp4


## Carla in Docker (Ubuntu 22.04 -> Ubuntu 20.04):
### activate carla in docker
```python
sudo docker run --privileged --gpus all --net=host -e DISPLAY=$DISPLAY carlasim/carla:latest /bin/bash ./CarlaUE4.sh
```
### setup the Python env
```python
conda activate [a python 3.8 env]
pip install carla_birdeye_view numpy tqdm carla pygame
```




## bug fixings

~~1. calculate the correct velocity and acceleration in Cartesian frame~~  
~~2. check the generated collision points~~  
~~3. add the spectator view~~  
~~4. confirm if the distance of the road bounds is corrected~~    
~~5. add traffic light controller in the intersections~~  
~~6. add bounding box for the SVs who has a potential field on the EV~~  
7. add recording  

## Reference

1. https://github.com/Faaizz/tuk_seminar  
2. https://github.com/BorveErik/MPC-Pathplan


