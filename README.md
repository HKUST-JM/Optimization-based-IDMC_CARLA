# MPC-APF

Reimplement the following senarios in Carla, we use 'apply_control' rather than setting tranformation of the vehicle directly.

- lane following
- obstacle avoidance

## Execute

```bash
# 1 test lane following senarios
python carla_1lane_following.py
# 2 test obstacle avoidance senarios
python carla_2obstacle_avoidance.py
```

## TODO

~~1. calculate the correct velocity and acceleration~~  
~~2. check the generated collision points~~  
~~3. add the spectator view~~  
~~4. confirm if the distance of the road bounds is corrected~~    
~~5. add traffic light~~  
~~6. add bounding box~~  
7. add recording  

## Reference

1. https://github.com/Faaizz/tuk_seminar  
2. https://github.com/BorveErik/MPC-Pathplan


# 22Fall_Project
Course project collaborate repository

## Install

### Simulator
```bash
# Windows
https://carla-releases.s3.eu-west-3.amazonaws.com/Windows/CARLA_0.9.13.zip

# Ubuntu(follow the below instruction)
https://carla.readthedocs.io/en/latest/start_quickstart/#a-debian-carla-installation
```
### Acados(optional)

```bash
cd /home/$USER
git clone https://github.com/acados/acados.git
cd acados
git submodule update --recursive --init
mkdir -p build
cd build
cmake -DACADOS_WITH_QPOASES=ON ..
# add more optional arguments e.g. -DACADOS_WITH_OSQP=OFF/ON -DACADOS_INSTALL_DIR=<path_to_acados_installation_folder> above
make install -j4
cd <path-to-acados_template>
pip install -e .

echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:"/home/$USER/acados/lib"
export ACADOS_SOURCE_DIR="/home/$USER/acados"' >> ~/.bashrc
```

### Python requirments

```bash
pip install -r requirements.txt
```

## RUN

### Test env

```python
# 1. run 
CarlaUE4.exe # Windows
CarlaUE4.sh  # Ubuntu

# 1.1 (optional) get additional performance improvement with no rendering
python official/config.py --no-rendering

# 2. test env scripts
# the scripts contains the process of basic initialization.
python scripts/env.py
```

### Run grid scenarios
```bash
# trajectory following
python grid_1lane_following.py

# static obstacle avoidance
python grid_2static_obstacle.py

# dynamic obstacle avoidance
python grid_3dynamic_obstacle.py

# car parking
python grid_4carparking.py

# car following
python grid_5carfollwoing.py
```

### Run carla scenarios
``` bash 
# trajectory tracking
python carla_1lane_following.py

# dynamic obstacle avoidance
python carla_2obstacle_avoidance.py
```

## File structure
```bash
-birdview_v2_cache # cache file generated by birdeye_view
-official # some reference examples provided by carla
-scripts # core implementation 
    - env.py # interact with carla, it includes spawn vehicles, initial visualization and carla environment, etc.
    - lane_change.py # not finish yet
    - other_agent.py # Be in charge of the behavior of other vehicles, like following the lane and change lane
    - vehicle.py # simulate the dynamics and calculate MPC(solvers is casadi)
    - vehicle_acados.py # similar with vehicle.py except the solver is acados
    - vehicle_obs.py # similar with vehicle.py but adding the obstacle constraints
    - vehicle_obs_parking.py # MPC core for carparking_exe.py based on vehicle_obs.py
    - x_agent.py # implement the main function, such as acc, overtaking and parking
-scenarios # set parameter of carpark and highway scenario
-utils # some third party or common function
-grid* and carla* # main entrance of program, run grid*.py to test the algorithm. The name with *grid* means testing in grid enviroment. carla* need to run carla simulator first.
```
## scenario infomation in Town5

```bash
# position
high_way(waypoint between intersection)
53.5, -204.3, 270
-8, -204. 270
11.3, 205.2, 90
58.1, 205.0, 90

parking lot entrance
21.1, -30.8, 270
parking lot position
-6.7, -27.1, 90
```

## Result

### Grid
#### lane following
![image](assert/lane_following.png)

#### static obstacle avoidance
![image](assert/static_obstacle_avoidance.png)

#### dynamic obstacle avoidance
![image](assert/dynamic_obstacle_avoidance.png)

#### car parking
![image](assert/car_parking_with_obs.png)

## Carla in Docker (Ubuntu 22.04 -> Ubuntu 20.04):
### activate carla in docker
```python
sudo docker run --privileged --gpus all --net=host -e DISPLAY=$DISPLAY carlasim/carla:latest /bin/bash ./CarlaUE4.sh
```
### setup the Python env
```python
conda activate [a python 3.8 env]
pip install carla_birdeye_view numpy tqdm carla pygame
```

## Useful repositories and websites:

1. https://github.com/YukunXia/Carla_iLQR_MPC

2. https://drive.google.com/file/d/1g6ATxZRTWEdstiZwfBN1_T_x_WwZs0zE/view

3. https://github.com/eecs219c/EECS219C_HW4_2/blob/3c75fff031ac5e9d9142e31af41c893836e4994e/examples/carla/overtake_control/overtake_control_simulator.py

4. https://www.zhihu.com/people/xie-xiao-fei-78-24/posts (**Carla Tutorial**)

5. https://zhuanlan.zhihu.com/p/149304322 (以Mohamed W. Mehrez[1]所提供的实例 (https://www.researchgate.net/publication/339294502_Model_Predictive_Control_without_terminal_constraints_or_costs_for_holonomic_mobile_robots )为基础，用Python来实现模型预测控制（MPC)和滚动时域估计（MHE）)

6. https://github.com/acados/acados/blob/master/examples/acados_python/race_cars/main.py (acados race car example)

7. https://github.com/neetmehta/Autonomous-turning-of-vehicle-and-overtaking-in-CARLA/blob/afda62dbf6b75343afaaf4cd49753cfc1e90ac84/agents/navigation/autonomous_agent.py(implement agent)

8. Project Report Writting Reference about MPC and vehicle model discretization: https://github.com/MMehrez/MPC-and-MHE-implementation-in-MATLAB-using-Casadi/blob/master/workshop_github/MPC_tracking.pdf
